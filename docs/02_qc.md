# 02. Quality Control (QC)

> **목표**: 원시 FASTQ에서 어댑터·저품질·저복잡성 서열을 제거한 뒤, 샘플/배치 수준 품질을 수치로 비교합니다.  
> **사용 도구**: FastQC, MultiQC, fastp (모두 conda 설치 가능)

---

## 0) 빠른 개요
1. 개별 QC(FastQC) → 트리밍/필터링(fastp) → 종합 리포트(MultiQC)
2. 전/후 변화: **reads 수, 평균 길이, Q30 비율, 어댑터 잔존** 확인
3. 결과물: `trim/*.fq.gz`, `trim/*.fastp.html/json`, `qc_report/multiqc_report.html`

---

## 1) 전제조건 & 폴더 구성

```bash
# 프로젝트 루트에서
mkdir -p raw trim qc_report logs scripts example_data


예시 데이터 파일명:

raw/S01_R1.fastq.gz, raw/S01_R2.fastq.gz
raw/S02_R1.fastq.gz, raw/S02_R2.fastq.gz

2) conda 환경 만들기

파일: pipeline/envs/qc.yaml

name: wgs-qc
channels:
  - bioconda
  - conda-forge
dependencies:
  - fastqc
  - multiqc
  - fastp


실행

mamba env create -f pipeline/envs/qc.yaml
conda activate wgs-qc

fastqc --version
multiqc --version
fastp --version

3) 샘플 테이블 준비

파일: example_data/sample_table.tsv

sample_id	r1	r2
S01	raw/S01_R1.fastq.gz	raw/S01_R2.fastq.gz
S02	raw/S02_R1.fastq.gz	raw/S02_R2.fastq.gz

4) 단일 샘플 QC
# (1) FastQC
fastqc raw/S01_R1.fastq.gz raw/S01_R2.fastq.gz -t 8 -o qc_report

# (2) fastp
fastp \
  -i raw/S01_R1.fastq.gz -I raw/S01_R2.fastq.gz \
  -o trim/S01_R1.fq.gz   -O trim/S01_R2.fq.gz \
  --detect_adapter_for_pe \
  --qualified_quality_phred 20 \
  --length_required 60 \
  --trim_poly_g \
  --low_complexity_filter \
  --thread 16 \
  --html trim/S01.fastp.html \
  --json trim/S01.fastp.json \
  > logs/S01.fastp.log 2>&1

# (3) MultiQC
multiqc . -o qc_report

5) 전체 샘플 일괄 QC 스크립트

파일: scripts/run_qc.sh

#!/usr/bin/env bash
set -euo pipefail

SHEET="example_data/sample_table.tsv"
THREADS=${THREADS:-16}

mkdir -p trim qc_report logs

# 1) FastQC
find raw -maxdepth 1 -name "*.fastq.gz" -print0 | \
  xargs -0 -n 8 -P 2 fastqc -t 8 -o qc_report || true

# 2) fastp
awk 'NR>1{print $1"\t"$2"\t"$3}' "$SHEET" | while IFS=$'\t' read -r SID R1 R2; do
  echo "[fastp] $SID"
  fastp \
    -i "$R1" -I "$R2" \
    -o "trim/${SID}_R1.fq.gz" -O "trim/${SID}_R2.fq.gz" \
    --detect_adapter_for_pe \
    --qualified_quality_phred 20 \
    --length_required 60 \
    --trim_poly_g \
    --low_complexity_filter \
    --thread "$THREADS" \
    --html "trim/${SID}.fastp.html" \
    --json "trim/${SID}.fastp.json" \
    > "logs/${SID}.fastp.log" 2>&1
done

# 3) MultiQC
multiqc . -o qc_report


실행:

chmod +x scripts/run_qc.sh
THREADS=16 bash scripts/run_qc.sh

6) 도구 비교
작업	권장 도구	대안	장점	산출물
개별 QC	FastQC	–	빠르고 직관적	HTML 리포트
종합 QC	MultiQC	–	여러 샘플 요약	HTML 리포트
트리밍/필터링	fastp	Trimmomatic, AdapterRemoval	속도+다기능 (어댑터 자동탐지, 폴리-G 제거)	FASTQ, HTML/JSON
저복잡성 제거	fastp(--low_complexity_filter)	PRINSEQ++	반복/저복잡성 제거	FASTQ
오염 제거	bbduk	–	phiX 등 특정 컨탐 제거	FASTQ
7) FastQC 모듈 해석
모듈	의미	흔한 패턴	권장 액션
Per base sequence quality	위치별 품질	말단 품질 하락	fastp로 트리밍
Per sequence GC content	시퀀스 GC 분포	다종 혼합 분포	극단적 이중 피크 = 오염 의심
Adapter content	어댑터 잔존	짧은 리드에서 흔함	--detect_adapter_for_pe
Overrepresented sequences	과대표 서열	어댑터/리보솜	BLAST/제거
Sequence length distribution	길이 분포	트리밍 후 짧아짐	컷 조정 필요
Duplication levels	중복도	저입력·PCR 샘플	필요시 dedup
8) 샘플 타입별 권장 파라미터
샘플 타입	최소 길이 컷	품질 컷(Q)	메모
대변(Fecal)	60	20	마이크로바이옴 DNA 풍부
점막/조직(Mucosa/Tissue)	60–75	20–25	host DNA ↑
FFPE	50–60	20	단편화 심해 짧은 리드 허용
9) 최종 체크리스트

 fastp 트리밍 완료 (trim/*.fq.gz)

 fastp 리포트 확인 (*.fastp.html/json)

 MultiQC 통합 리포트 확인 (multiqc_report.html)

 QC 요약 테이블 필요 시 생성

 Host DNA 제거 단계로 결과 전달
